<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width"/>
    <meta name="viewport" content="initial-scale=1.0"/>
    <meta name="viewport" content="maximum-scale=1.0"/>
    <meta name="viewport" content="user-scalable=1.0"/>
    <title>树莓派</title>
	<link rel="stylesheet" type="text/css"href="css/menu.css"/>
	<script src="js/hidpi-canvas.min.js?ver=1"></script>
	<script type="text/javascript" src="js/footer.js"></script>
	<script type="text/javascript" src="js/header.js"></script>
	<script type="text/javascript" src="js/websocket.js"></script>;
	<script type="text/javascript" src="js/data.js"></script>;
    <script>
		ws = null;
		timer = null;
		_port = 8000;
		window.onload = function(){
			document.getElementById("wrap").style.display="block";
			
			var _title = ['灯光设置', '窗帘设置', '空调设置', '电视设置'];
			var news=document.getElementById("news_ul");
			for(var i=0;i<_title.length;i++){
				var li = create_element(news, 'li', null, null, null);
				var a = create_element(li, 'a', null, null, _title[i]);
				a.setAttribute("href", 'javascript:onNewsTitle(' + i + ');');
				li.style.border = "0px";
				li.style.borderBottomStyle ="none";
			}
			setTimeout(function() {onNewsTitle(0);},20);
			
			doInitFooter('footer', 1);
			doInitHeader('header', 0);
			
			ws = websocket.prototype.connect(document.domain, _port, onmessage, onopen, onclose, null);
		}
		
		var titles = ["lamp", "curtain", "air_conditioner", "tv"];
		showPage = function(title){
			for(var i in titles){
				if(titles[i] === title)
					document.getElementById(titles[i]).style.display="block";
				else
					document.getElementById(titles[i]).style.display="none";
			}
		}
		
		onNewsTitle = function(i){
			var news=document.getElementById("news_ul");
			var elem_child = news.getElementsByTagName("li"); 
			for(var j=0;j<elem_child.length;j++)
			{
				var a = elem_child[j].getElementsByTagName("a")[0]; 
				if(i == j){
					a.style.color = '#f00';
					a.style.background = getMenuImg(0);
				}
				else{
					a.style.color = '#fff';
					a.style.background = 'transparent';
				}
			}

			if(0 == i){
				showPage("lamp");
			}
			else if(1 == i){
				showPage("curtain");
			}
			else if(2 == i){
				showPage("air_conditioner");
			}
			else if(3 == i){
				showPage("tv");
			}
		}
		

			//websocket 处理函数
	onmessage = function(evt)
	{
		if(typeof evt.data != 'string')
			return;
		var json = JSON.parse(evt.data);
		if(!json)
			return;
		
		if( json.event === "device" ){
			_DEVICE_ = json.data;
			
			if(_header)
				_header.doDraw();
		} 
		else if( json.event === "lamp" ){

			_LAMP_[json.mode] = json.data;

			mode = json.mode;
		} 

		window.frames['flamp'].postMessage({'msg':'onmessage' , 'data':evt.data},'*');
		window.frames['fcurtain'].postMessage({'msg':'onmessage' , 'data':evt.data},'*');
		window.frames['fair_conditioner'].postMessage({'msg':'onmessage' , 'data':evt.data},'*');
		window.frames['ftv'].postMessage({'msg':'onmessage' , 'data':evt.data},'*');
	}
	onopen = function()
	{
		if(timer)
			clearInterval(timer);
		
		ws.handshake = true;
	}
	
	onclose = function()
	{
		ws.handshake = false;
		
		if(timer)
			clearInterval(timer);
		
		timer = setInterval(function(){
			ws = websocket.prototype.connect(document.domain, _port, onmessage, onopen, onclose, null);
			}, 5000);
	}
    </script>
</head>
<body>

<div id = "wrap" style="display:none;overflow-y:auto;height: 100%; position: relative;width:100%;background:white;margin:0 auto;max-width:1080px;">
	<div id = "div_header" align="left">
		<div align="left">
			<canvas id="header" align="left">
		</div>
		<div class="menu" id = "news" align="left">
			<ul id = "news_ul">
			</ul>
		</div>
	</div>
	
	<div><!--固定头的点位符-->
		<canvas align="left" style="visibility:hidden;height: 240px;">
	</div>
	
	<div id="lamp" style="display:block">
		<iframe name="flamp" src='dev_set.html?dev_id=lamp' class="myframe"></iframe>
	</div>
	<div id="curtain" style="display:none">
		<iframe name="fcurtain" src='dev_set.html?dev_id=curtain' class="myframe"></iframe>
	</div>
	<div id="air_conditioner" style="display:none">
		<iframe name="fair_conditioner" src='dev_set.html?dev_id=air_conditioner' class="myframe"></iframe>
	</div>
	<div id="tv" style="display:none">
		<iframe name="ftv" src='dev_set.html?dev_id=tv' class="myframe"></iframe>
	</div>
	<div id="div_footer"><canvas id="footer" align="left"></canvas></div>
</div>
</body>
</html>